@startuml
title Механика доставки Push-сообщений FCM

start

#palegreen :Push-сообщение поступает на устройство;
-[#green]->
if (Приложение на переднем плане (foreground)?) then (да)
    -[#green]->
    partition "Код приложения" {
        #palegreen:Вызывается `onMessageReceived()`;
        #palegreen:Разработчик полностью контролирует обработку:
        - может показать UI внутри приложения
        - может создать уведомление вручную
        - может выполнить фоновую логику;
    }
else (нет, в фоне или закрыто)
    if (Сообщение содержит `notification` payload?) then (да)
        partition "Устройство / FCM SDK" {
            :FCM SDK **автоматически** отображает системное уведомление;
            note right
                Код приложения
                (`onMessageReceived`)
                **не выполняется!**
            end note
            :Пользователь нажимает на уведомление;
            :Приложение открывается.
            Intent с данными из push-сообщения
            передается в MainActivity;
        }
    else (нет, только `data` payload)
         partition "Код приложения" {
            :Вызывается `onMessageReceived()`;
            :Разработчик обрабатывает данные в фоне
            (например, для синхронизации или
            создания кастомного уведомления вручную);
        }
    endif
endif

stop
@enduml